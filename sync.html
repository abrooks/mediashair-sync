<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" style=" overflow:auto; overflow: hidden\9;" class="xIndex" >
  <head>
    <!-- Color scheme
    http://www.paletton.com/#uid=2000u0kllllaFw0g0qFqFg0w0aF
    http://www.paletton.com/#uid=5000u0kllllaFw0g0qFqFg0w0aF
    http://www.paletton.com/#uid=3000u0kllllaFw0g0qFqFg0w0aF
    -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>MediaShair sync</title>
    <style>.NOpt{maring-top:-165px;}</style>
    <script src="jquery.min.js" type="text/javascript" jss="html/index"></script>
    <script src="react.js" type="text/javascript" jss="html/index"></script>
    <script src="JSXTransformer.js" type="text/javascript" jss="html/index"></script>
    <script type="text/jsx">
     /** @jsx React.DOM */
     var BASE_URL = 'http://10.10.10.254/data/';
     var datas = {'Foo': {},
                  'UsbDisk2/Volume1/images/': {},
                  'Long/path/name/for/testing/purposes/here': {},
                  'Foo/Bar': {'zerp': {size: 1, time: 1},
                              'zoop': {size: 11, time: 3},
                              'zip': {size: 2, time: 2},
                              'zep': {size: 2, time: 2},
                              'zop': {size: 100, time: 9}},
                  'Foo/Baz': {'zerp': {size: 2, time: 1},
                              'zoip': {size: 11, time: 3},
                              'zip': {size: 2, time: 2},
                              'zep': {size: 3, time: 2},
                              'zap': {size: 100, time: 9}}};

     var SyncButtons = React.createClass({
       render: function(){
         return(<div>
                <button id='new' type='button' onClick={this.props.syncNew}>New</button>
                <button id='full' type='button' onClick={this.props.syncFull}>Full</button>
                <button id='del' type='button' onClick={this.props.syncDel}>Del</button>
                </div>);
       }
     });

     var SyncFiles = React.createClass({
       render: function(){
         var items = [];
         var content = <div/>;
         if( this.props.files && this.props.files.length != 0 ) {
           this.props.files.forEach(function(f) {
             items.push(<div key={f.name}>{f.name}, {f.size} bytes, {f.time}</div>);
           });
           content = <span><h1>{this.props.fmode}</h1>{items}</span>;
         }
         return(content);
       }
     });

     var SyncUI = React.createClass({
       syncCopies: function(items, from, to) {
         var item = items[0];
         var root_this = this;
         if( item ) {
           var rest = items.slice(1);
           console.log("copying", item.name, rest, from, to);
           doCOPY(from + '/' + item.name,
                  to + '/' + item.name,
                  function() {
               console.log("copy done", item.name, arguments);
               root_this.syncCopies(rest, from, to);
             });
         }
       },
       syncDeletes: function(targets, path) {
         var item = targets[0];
         var root_this = this;
         if( item ) {
           var rest = targets.slice(1);
           console.log("deleting", item.name, rest, path);
           doDELETE(path + '/' + item.name,
                  function() {
               console.log("delete done", item.name, arguments);
               root_this.syncDeletes(rest, path);
             });
         }
       },
       syncDel: function(id){
         this.syncDeletes(this.props.fdel, BASE_URL + this.props.to);
       },
       syncNew: function(id){
         this.syncCopies(this.props.fnew,
                         BASE_URL + this.props.from,
                         BASE_URL + this.props.to);
       },
       syncFull: function(id){
         this.syncDeletes(this.props.fdel, BASE_URL + this.props.to);
         this.syncCopies(this.props.fnew,
                         BASE_URL + this.props.from,
                         BASE_URL + this.props.to);
       },
       render: function(){
         return(<div>
                <SyncButtons syncNew={this.syncNew} syncFull={this.syncFull} syncDel={this.syncDel}/>
                <br/>
                <span>
                <SyncFiles fmode='del' files={this.props.fdel}/>
                <SyncFiles fmode='changed' files={this.props.fchanged}/>
                <SyncFiles fmode='new' files={this.props.fnew}/>
                </span>
                </div>);
       }
     });

     var PathDropdown = React.createClass({
       handleChange: function(){
         this.props.onSelectionChange(
           this.refs.selectedInput.getDOMNode().id,
           this.refs.selectedInput.getDOMNode().value
         );
       },
       render: function(){
         var paths = [<option value='' disabled='disabled' key={this.props.dir}>
                      Select path...</option>];
         var root_this = this;
         Object.keys(this.props.data).forEach(function(path){
           var count = Object.keys(root_this.props.data[path]).length;
           paths.push(<option value={path} key={path}>{path} ({count})</option>);
         });
         return (<span><div>{this.props.dir}:</div>
                 <div>
                 <select id={this.props.dir}
                 defaultValue={this.props.selected}
                 value={this.props.selected}
                 onChange={this.handleChange}
                 ref='selectedInput'>
                 {paths}
                 </select>
                 </div>
                 </span>);
       }
     });

     var dirdiff =  function(from, to) {
       var diff = [];
       Object.keys(from).forEach(function(k) {
         if(! to[k]) {
             diff.push({name: k, size: from[k].size, time: from[k].time});
         }
       });
       return diff;
     };

     var dirchanged =  function(from, to, same_size, same_time) {
       var diff = [];
       Object.keys(from).forEach(function(k) {
         if (to[k] && ((same_size && (to[k].size != from[k].size))
                       || (same_time && (to[k].time != from[k].time)))) {
           diff.push({name: k, size: from[k].size, time: from[k].time});
         }
       });
       return diff;
     };

    var getPROPFIND = function(path, cb) {
       $.ajax(path,
              {type: "PROPFIND",
               dataType: "xml",
               headers: {"Content-Type": "text/xml; charset=\"utf-8\"", Depth: 1}})
               .done(cb)
               .fail(function(x){console.log('PROPFIND fail', x, path);});
     };

     var doCOPY = function(src, dst, cb) {
       $.ajax(src,
              {type: "COPY",
               dataType: "text",
               //ovTime: 0,
               //onCensor: "xx",
               headers: {Destination: dst, Depth:1}})
            .done(cb)
            .fail(function (){console.log('COPY fail', arguments);});
     }

     var doDELETE = function(target, cb) {
       $.ajax(target,
              {type: "DELETE",
               dataType: "text",
               headers: {}})
            .done(cb)
            .fail(function (){console.log('DELETE fail', arguments);});
     }

     var FullUI = React.createClass({
       getInitialState: function() {
         return {pathinfo: {}, from:'', to:'', todo: [], inprogress: []};
       },
       refreshCB: function(data, val) {
         var root_this = this;
         var pathinfo = this.state.pathinfo;
         var $xml = $( data ), resps = $xml.find('response');
         resps.toArray().slice(1).forEach(function (r) {
           var $r = $( r );
           var h = $r.find('href').text();
           var s = $r.find('getcontentlength').text();
           var ts = $r.find('getlastmodified').text();
           var c = $r.find('collection').toArray()[0];
           if( c ) {
             if( h.indexOf('/.') == -1 ) {
               var p = h.replace(BASE_URL, '');
               pathinfo[p] = {}
               root_this.setState({pathinfo: pathinfo});
               getPROPFIND(h, root_this.refreshCB);
             }
           } else {
             var p = h.replace(BASE_URL, '').replace(/\/[^/]*$/,'');
             var f = h.replace(BASE_URL, '').replace(/.*\//,'');
             pathinfo[p][f] = {size: s, time: ts};
             root_this.setState({pathinfo: pathinfo});
           }
         });
       },
       myRefresh: function(event, val) {
         this.setState({pathinfo: {}, to: '', from: ''});
         getPROPFIND(BASE_URL, this.refreshCB);
       },
       fakeRefresh: function(event, val) {
         this.setState({pathinfo: datas, to: '', from: ''});
       },
       onSelectionChange: function(id, val) {
         var update = {}
         update[id.toLowerCase()] = val
         console.log("onSelectionChange", update);
         this.setState(update);
       },
       render: function() {
         var from = this.state.from ? this.state.pathinfo[this.state.from] : {};
         var to = this.state.to ? this.state.pathinfo[this.state.to] : {};
         var fnew = [];
         var fchanged = [];
         var fdel = [];
         if ( this.state.from && this.state.to ) {
           fnew = dirdiff(from, to);
           fdel = dirdiff(to, from);
           fchanged = dirchanged(from,to,true,true);
         }
         return (<div>
                 <button id='myRefresh' type='button' onClick={this.myRefresh}>Refresh</button>
                 <button id='fakeRefresh' type='button' onClick={this.fakeRefresh}>FakeRefresh</button>
                 <hr/>
                 <PathDropdown dir='From' data={this.state.pathinfo} selected={this.state.from} onSelectionChange={this.onSelectionChange}/>
                 <PathDropdown dir='To' data={this.state.pathinfo} selected={this.state.to} onSelectionChange={this.onSelectionChange}/>
                 <hr/>
                 <SyncUI from={this.state.from} to={this.state.to} fnew={fnew} fdel={fdel} fchanged={fchanged}/>
                 </div>);
       }
     });
    </script>

  </head>
  <body>
    <script type="text/jsx">
      /** @jsx React.DOM */
      React.renderComponent(
      <div>
        <FullUI/>
      </div>,
      document.body
      );
    </script>
  </body>
